# 测试决策执行情况

## 快速开始

### 基本用法

```bash
# 查看最近24小时的决策和执行情况
python test_decision_execution.py

# 查看最近12小时的决策
python test_decision_execution.py --hours 12

# 只查看某个Agent的决策
python test_decision_execution.py --agent agent_1

# 同时查询API中的订单历史
python test_decision_execution.py --orders

# 显示当前账户余额
python test_decision_execution.py --balance

# 组合使用
python test_decision_execution.py --hours 6 --agent agent_1 --orders --balance
```

## 输出说明

### 1. 决策详情

脚本会显示每个决策的详细信息：
- **决策ID**: 数据库中的唯一标识
- **Agent**: 生成决策的Agent名称
- **时间**: 决策生成的时间
- **状态**: pending/success/failed/skipped
- **JSON格式有效**: 决策是否符合JSON格式要求
- **决策内容**: 决策的原始文本

### 2. 执行结果

如果决策被执行，会显示：
- **订单ID**: API返回的订单ID（如果成功）
- **状态**: success/failed/skipped
- **执行时间**: 订单执行耗时（秒）
- **错误**: 如果失败，显示错误信息

### 3. 统计摘要

- **总决策数**: 时间范围内的决策总数
- **成功执行**: 状态为success的决策数
- **执行失败**: 状态为failed的决策数
- **跳过/等待**: 状态为skipped或wait/hold的决策数
- **成功率**: 成功执行的百分比

### 4. API订单查询（--orders选项）

如果使用 `--orders` 选项，脚本会：
- 从Roostoo API查询实际的订单历史
- 显示订单详情（订单ID、交易对、方向、类型、状态等）
- 验证数据库中的订单ID是否在API中存在

### 5. 账户余额（--balance选项）

如果使用 `--balance` 选项，脚本会：
- 查询当前账户余额
- 显示各币种的可用、锁定和总余额
- 可以用来验证交易是否真的影响了账户余额

## 如何判断决策是否成功传递到市场？

### ✅ 成功标志

1. **执行结果状态为 `success`**
   ```
   执行结果:
     订单ID: 12345
     状态: success
   ```

2. **有有效的订单ID**
   - 如果订单ID不是 `dry_run_xxx` 格式，说明是真实订单

3. **API查询确认**
   - 使用 `--orders` 选项，在API中能找到对应的订单
   - 订单状态为 `FILLED` 或 `PENDING`

4. **账户余额变化**
   - 使用 `--balance` 选项，查看余额是否按预期变化

### ❌ 失败标志

1. **执行结果状态为 `failed`**
   ```
   执行结果:
     状态: failed
     错误: Decision cannot be parsed
   ```

2. **执行结果状态为 `skipped`**
   ```
   执行结果:
     状态: skipped
     错误: Decision is wait/hold, no action needed
   ```
   - 这是正常的，wait/hold决策不需要执行

3. **没有执行结果**
   - 决策状态为 `pending`，说明还没有被处理

## 常见问题

### Q: 为什么有些决策没有执行结果？

A: 可能的原因：
1. 决策是 `wait/hold`，不需要执行
2. 决策格式错误，无法解析
3. 决策还在处理队列中（状态为pending）

### Q: 如何确认订单真的在市场上？

A: 使用以下方法：
1. 运行 `python test_decision_execution.py --orders` 查看API中的订单
2. 运行 `python test_decision_execution.py --balance` 查看余额变化
3. 检查订单ID是否在API返回的订单列表中

### Q: DRY_RUN模式下如何测试？

A: 在DRY_RUN模式下：
- 决策会被记录到数据库
- 执行结果状态为 `success`，但订单ID是 `dry_run_xxx` 格式
- API中不会有真实订单
- 账户余额不会变化

### Q: 如何查看特定时间段的决策？

A: 使用 `--hours` 参数：
```bash
# 查看最近1小时
python test_decision_execution.py --hours 1

# 查看最近48小时
python test_decision_execution.py --hours 48
```

## 示例输出

```
================================================================================
决策执行情况测试
================================================================================
时间范围: 最近 24 小时
数据库: decisions.db
================================================================================

[1] 从数据库获取决策...
✓ 找到 5 个决策

[2] 获取执行结果...
✓ 找到 5 个执行结果

[3] 决策详情:

================================================================================
决策 ID: 1
Agent: agent_1
时间: 2025-11-11 11:04:34
状态: success
JSON格式有效: True
决策内容: {"action": "buy", "quantity": 0.01, "symbol": "BTCUSDT"}

执行结果:
  订单ID: 12345
  状态: success
  执行时间: 0.5秒
================================================================================

================================================================================
统计摘要
================================================================================
总决策数: 5
成功执行: 3
执行失败: 0
跳过/等待: 2
成功率: 60.00%
================================================================================
```

## 注意事项

1. **数据库路径**: 默认使用 `decisions.db`，如果数据库在其他位置，使用 `--db` 参数指定
2. **API连接**: 使用 `--orders` 和 `--balance` 需要有效的API配置
3. **时间范围**: 默认查看最近24小时，可以根据需要调整


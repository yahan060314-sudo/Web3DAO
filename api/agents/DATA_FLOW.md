# æ•°æ®æµæ–‡æ¡£ - ä¿¡æ¯å¯¼å…¥Agentçš„å®Œæ•´æµç¨‹

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ä»Roostooå¸‚åœºæ•°æ®åˆ°AI Agentå†³ç­–çš„å®Œæ•´æ•°æ®æµã€‚

## å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®é‡‡é›†å±‚ (Data Collection)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Roostoo API                                                    â”‚
â”‚  - get_ticker(pair) â†’ åŸå§‹tickeræ•°æ®                            â”‚
â”‚  - get_balance() â†’ åŸå§‹balanceæ•°æ®                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MarketDataCollector (api/agents/market_collector.py)           â”‚
â”‚  - å®šæœŸè°ƒç”¨RoostooClientè·å–æ•°æ®                                â”‚
â”‚  - ä½¿ç”¨DataFormatteræ ¼å¼åŒ–æ•°æ®                                  â”‚
â”‚  - å‘å¸ƒåˆ°MessageBus (topic: "market_ticks")                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®æ ¼å¼åŒ–å±‚ (Data Formatting)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataFormatter (api/agents/data_formatter.py)                   â”‚
â”‚  - format_ticker() â†’ ç»“æ„åŒ–tickeræ•°æ®                            â”‚
â”‚  - format_balance() â†’ ç»“æ„åŒ–balanceæ•°æ®                         â”‚
â”‚  - create_market_snapshot() â†’ ç»¼åˆå¸‚åœºå¿«ç…§                      â”‚
â”‚  - format_for_llm() â†’ LLMå¯è¯»çš„è‡ªç„¶è¯­è¨€æ–‡æœ¬                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¶ˆæ¯æ€»çº¿å±‚ (Message Bus)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   â”‚
                    â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Market Topic            â”‚  â”‚  Dialog Topic             â”‚
â”‚  "market_ticks"          â”‚  â”‚  "dialog_prompts"         â”‚
â”‚  - tickeræ•°æ®            â”‚  â”‚  - promptæ¶ˆæ¯             â”‚
â”‚  - balanceæ•°æ®           â”‚  â”‚                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚                   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Promptç®¡ç†å±‚ (Prompt Management)                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PromptManager (api/agents/prompt_manager.py)                   â”‚
â”‚  - get_system_prompt() â†’ ç³»ç»Ÿæç¤ºè¯ï¼ˆå®šä¹‰Agentè§’è‰²ï¼‰            â”‚
â”‚  - create_trading_prompt() â†’ äº¤æ˜“æç¤ºè¯ï¼ˆåŒ…å«å¸‚åœºæ•°æ®ï¼‰          â”‚
â”‚  - create_spot_prompt_from_market_data() â†’ ä½¿ç”¨ç»„å‹çš„æ¨¡æ¿        â”‚
â”‚  - æ•´åˆprompts/natural_language_prompt.txt                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Agentå¤„ç†å±‚ (Agent Processing)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BaseAgent (api/agents/base_agent.py)                           â”‚
â”‚  - è®¢é˜…market_topic â†’ æ¥æ”¶å¸‚åœºæ•°æ®                              â”‚
â”‚  - è®¢é˜…dialog_topic â†’ æ¥æ”¶promptæ¶ˆæ¯                            â”‚
â”‚  - _handle_market_data() â†’ èšåˆå¸‚åœºæ•°æ®                         â”‚
â”‚  - _handle_dialog() â†’ å¤„ç†promptæ¶ˆæ¯                            â”‚
â”‚  - _generate_decision() â†’ ä½¿ç”¨LLMç”Ÿæˆå†³ç­–                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLMå¤„ç† (LLM Processing)                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LLM Client (api/llm_clients/)                                  â”‚
â”‚  - DeepSeekClient / QwenClient                                  â”‚
â”‚  - chat(messages) â†’ ç”Ÿæˆè‡ªç„¶è¯­è¨€å†³ç­–                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å†³ç­–è¾“å‡ºå±‚ (Decision Output)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MessageBus (topic: "decisions")                                â”‚
â”‚  - å‘å¸ƒAgentå†³ç­–                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TradeExecutor (api/agents/executor.py)                         â”‚
â”‚  - è®¢é˜…decisions topic                                          â”‚
â”‚  - è§£æè‡ªç„¶è¯­è¨€å†³ç­–                                             â”‚
â”‚  - æ‰§è¡Œäº¤æ˜“ï¼ˆè°ƒç”¨RoostooClient.place_order()ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## è¯¦ç»†æ•°æ®æµè¯´æ˜

### 1. æ•°æ®é‡‡é›†é˜¶æ®µ

**ç»„ä»¶**: `MarketDataCollector`

**æµç¨‹**:
1. å®šæœŸè°ƒç”¨ `RoostooClient.get_ticker(pair)` è·å–tickeræ•°æ®
2. å®šæœŸè°ƒç”¨ `RoostooClient.get_balance()` è·å–ä½™é¢æ•°æ®
3. ä½¿ç”¨ `DataFormatter.format_ticker()` æ ¼å¼åŒ–ticker
4. ä½¿ç”¨ `DataFormatter.format_balance()` æ ¼å¼åŒ–balance
5. å‘å¸ƒåˆ° `MessageBus` (topic: `"market_ticks"`)

**æ•°æ®æ ¼å¼**:
```python
# Tickeræ•°æ®
{
    "type": "ticker",
    "pair": "BTC/USD",
    "price": 45000.0,
    "volume_24h": 1234567.89,
    "change_24h": 2.5,
    "timestamp": 1234567890.0
}

# Balanceæ•°æ®
{
    "type": "balance",
    "total_balance": 10000.0,
    "available_balance": 8000.0,
    "currencies": {
        "USD": {"available": 8000.0, "total": 8000.0},
        "BTC": {"available": 0.1, "total": 0.1}
    }
}
```

### 2. æ•°æ®èšåˆé˜¶æ®µ

**ç»„ä»¶**: `BaseAgent._handle_market_data()`

**æµç¨‹**:
1. æ¥æ”¶æ¥è‡ªMessageBusçš„å¸‚åœºæ•°æ®æ¶ˆæ¯
2. æ ¹æ®æ•°æ®ç±»å‹ï¼ˆticker/balanceï¼‰åˆ†åˆ«å­˜å‚¨
3. ä½¿ç”¨ `DataFormatter.create_market_snapshot()` åˆ›å»ºç»¼åˆå¿«ç…§
4. æ›´æ–° `self.last_market_snapshot`

**æ•°æ®æ ¼å¼**:
```python
{
    "type": "market_snapshot",
    "timestamp": 1234567890.0,
    "ticker": {...},  # æ ¼å¼åŒ–çš„tickeræ•°æ®
    "balance": {...}  # æ ¼å¼åŒ–çš„balanceæ•°æ®
}
```

### 3. Promptç”Ÿæˆé˜¶æ®µ

**ç»„ä»¶**: `PromptManager`

**ä¸¤ç§æ–¹å¼**:

#### æ–¹å¼1: ä½¿ç”¨é»˜è®¤promptï¼ˆè‹±æ–‡ï¼Œç®€å•ï¼‰
```python
pm = PromptManager()
prompt = pm.create_trading_prompt(market_snapshot)
```

#### æ–¹å¼2: ä½¿ç”¨ç»„å‹çš„è¯¦ç»†æ¨¡æ¿ï¼ˆä¸­æ–‡ï¼ŒåŒ…å«ä¸¥æ ¼è§„åˆ™ï¼‰
```python
pm = PromptManager()
prompt = pm.create_spot_prompt_from_market_data(
    market_snapshot=snapshot,
    price_series="...",  # å¯é€‰
    volume_series="...",  # å¯é€‰
    recent_sharpe="0.72",  # å¯é€‰
    trade_stats="win=62%"  # å¯é€‰
)
```

**ç»„å‹çš„æ¨¡æ¿ç‰¹ç‚¹**:
- ä¸­æ–‡æç¤ºè¯
- ä¸¥æ ¼çš„äº¤æ˜“è§„åˆ™ï¼ˆç¦æ­¢æ æ†ã€ç¦æ­¢åšç©ºï¼‰
- è¯¦ç»†çš„é£é™©ç®¡ç†åè®®
- è¦æ±‚JSONæ ¼å¼è¾“å‡º
- åŒ…å«å†·å´æœŸã€è¿äºæš‚åœç­‰è§„åˆ™

### 4. Agentå¤„ç†é˜¶æ®µ

**ç»„ä»¶**: `BaseAgent._generate_decision()`

**æµç¨‹**:
1. æ„å»ºLLMæ¶ˆæ¯åˆ—è¡¨ï¼š
   - System message: ç³»ç»Ÿæç¤ºè¯ï¼ˆå®šä¹‰Agentè§’è‰²ï¼‰
   - System message: å¸‚åœºæ•°æ®ï¼ˆæ ¼å¼åŒ–ä¸ºè‡ªç„¶è¯­è¨€ï¼‰
   - User messages: å¯¹è¯å†å²ï¼ˆæœ€è¿‘5æ¡ï¼‰
   - User message: å½“å‰ç”¨æˆ·æç¤ºè¯
2. è°ƒç”¨ `llm.chat(messages)` ç”Ÿæˆå†³ç­–
3. å‘å¸ƒå†³ç­–åˆ°MessageBus (topic: `"decisions"`)

**LLMè¾“å…¥ç¤ºä¾‹**:
```python
messages = [
    {
        "role": "system",
        "content": "You are TradingAgent, an AI trading assistant..."
    },
    {
        "role": "system",
        "content": "Current Market Data:\nğŸ“Š Market Data (BTC/USD):\n  Current Price: $45000.00\n..."
    },
    {
        "role": "user",
        "content": "Analyze the current market situation and make a trading decision..."
    }
]
```

### 5. å†³ç­–æ‰§è¡Œé˜¶æ®µ

**ç»„ä»¶**: `TradeExecutor`

**æµç¨‹**:
1. è®¢é˜… `"decisions"` topic
2. æ¥æ”¶Agentçš„è‡ªç„¶è¯­è¨€å†³ç­–
3. è§£æå†³ç­–ï¼ˆä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå–buy/sell/quantityç­‰ï¼‰
4. è°ƒç”¨ `RoostooClient.place_order()` æ‰§è¡Œäº¤æ˜“
5. éµå®ˆé™é¢‘è§„åˆ™ï¼ˆ`TRADE_INTERVAL_SECONDS = 61`ï¼‰

## å…³é”®æ•°æ®è½¬æ¢ç‚¹

### è½¬æ¢ç‚¹1: åŸå§‹æ•°æ® â†’ ç»“æ„åŒ–æ•°æ®
- **ä½ç½®**: `DataFormatter.format_ticker()` / `format_balance()`
- **è¾“å…¥**: Roostoo APIåŸå§‹JSON
- **è¾“å‡º**: ç»Ÿä¸€çš„ç»“æ„åŒ–å­—å…¸

### è½¬æ¢ç‚¹2: ç»“æ„åŒ–æ•°æ® â†’ è‡ªç„¶è¯­è¨€
- **ä½ç½®**: `DataFormatter.format_for_llm()`
- **è¾“å…¥**: å¸‚åœºå¿«ç…§å­—å…¸
- **è¾“å‡º**: è‡ªç„¶è¯­è¨€æ–‡æœ¬æè¿°

### è½¬æ¢ç‚¹3: å¸‚åœºæ•°æ® â†’ Prompt
- **ä½ç½®**: `PromptManager.create_spot_prompt_from_market_data()`
- **è¾“å…¥**: å¸‚åœºå¿«ç…§ + å¯é€‰å‚æ•°
- **è¾“å‡º**: å®Œæ•´çš„äº¤æ˜“æç¤ºè¯ï¼ˆä½¿ç”¨ç»„å‹çš„æ¨¡æ¿ï¼‰

### è½¬æ¢ç‚¹4: Prompt â†’ LLMå†³ç­–
- **ä½ç½®**: `BaseAgent._generate_decision()`
- **è¾“å…¥**: ç³»ç»Ÿæç¤ºè¯ + å¸‚åœºæ•°æ® + ç”¨æˆ·æç¤ºè¯
- **è¾“å‡º**: è‡ªç„¶è¯­è¨€å†³ç­–æ–‡æœ¬

### è½¬æ¢ç‚¹5: è‡ªç„¶è¯­è¨€å†³ç­– â†’ äº¤æ˜“æŒ‡ä»¤
- **ä½ç½®**: `TradeExecutor._parse_decision()`
- **è¾“å…¥**: è‡ªç„¶è¯­è¨€å†³ç­–æ–‡æœ¬
- **è¾“å‡º**: ç»“æ„åŒ–äº¤æ˜“å‚æ•°ï¼ˆside, quantity, price, pairï¼‰

## æ¨¡å—èŒè´£æ€»ç»“

| æ¨¡å— | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|------|------|------|------|
| **RoostooClient** | APIé€šä¿¡ | APIè¯·æ±‚ | åŸå§‹JSONæ•°æ® |
| **MarketDataCollector** | æ•°æ®é‡‡é›† | RoostooClient | æ ¼å¼åŒ–çš„å¸‚åœºæ•°æ®ï¼ˆå‘å¸ƒåˆ°MessageBusï¼‰ |
| **DataFormatter** | æ•°æ®æ ¼å¼åŒ– | åŸå§‹æ•°æ® | ç»“æ„åŒ–æ•°æ® / è‡ªç„¶è¯­è¨€æ–‡æœ¬ |
| **PromptManager** | Promptç®¡ç† | å¸‚åœºå¿«ç…§ | å®Œæ•´çš„äº¤æ˜“æç¤ºè¯ |
| **BaseAgent** | Agentå¤„ç† | å¸‚åœºæ•°æ® + Prompt | è‡ªç„¶è¯­è¨€å†³ç­– |
| **TradeExecutor** | äº¤æ˜“æ‰§è¡Œ | è‡ªç„¶è¯­è¨€å†³ç­– | å®é™…äº¤æ˜“è®¢å• |

## æ•°æ®æµéªŒè¯æ£€æŸ¥ç‚¹

1. âœ… **MarketDataCollectoræ˜¯å¦æ­£å¸¸é‡‡é›†æ•°æ®ï¼Ÿ**
   - æ£€æŸ¥æ—¥å¿—ï¼š`[MarketDataCollector] Published ticker for BTC/USD`
   - æ£€æŸ¥æ—¥å¿—ï¼š`[MarketDataCollector] Published balance`

2. âœ… **BaseAgentæ˜¯å¦æ¥æ”¶åˆ°å¸‚åœºæ•°æ®ï¼Ÿ**
   - æ£€æŸ¥ `self.last_market_snapshot` æ˜¯å¦ä¸ä¸ºNone
   - æ£€æŸ¥ `self.current_tickers` å’Œ `self.current_balance` æ˜¯å¦æœ‰æ•°æ®

3. âœ… **Promptæ˜¯å¦æ­£ç¡®ç”Ÿæˆï¼Ÿ**
   - æ£€æŸ¥ `PromptManager.spot_trading_template` æ˜¯å¦åŠ è½½æˆåŠŸ
   - æ£€æŸ¥ç”Ÿæˆçš„promptæ˜¯å¦åŒ…å«æ‰€æœ‰å ä½ç¬¦

4. âœ… **Agentæ˜¯å¦ç”Ÿæˆå†³ç­–ï¼Ÿ**
   - æ£€æŸ¥æ—¥å¿—ï¼š`[AgentName] Published decision: ...`
   - æ£€æŸ¥MessageBusçš„decisions topicæ˜¯å¦æœ‰æ¶ˆæ¯

5. âœ… **TradeExecutoræ˜¯å¦æ‰§è¡Œäº¤æ˜“ï¼Ÿ**
   - æ£€æŸ¥æ—¥å¿—ï¼š`[Executor] Placed order: ...`
   - æ£€æŸ¥Roostoo APIæ˜¯å¦æ”¶åˆ°è®¢å•

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: Agentæ²¡æœ‰æ¥æ”¶åˆ°å¸‚åœºæ•°æ®
- **æ£€æŸ¥**: MarketDataCollectoræ˜¯å¦å¯åŠ¨
- **æ£€æŸ¥**: MessageBusçš„market_topicæ˜¯å¦æ­£ç¡®
- **æ£€æŸ¥**: BaseAgentæ˜¯å¦æ­£ç¡®è®¢é˜…

### é—®é¢˜2: Promptæ¨¡æ¿æœªåŠ è½½
- **æ£€æŸ¥**: `prompts/natural_language_prompt.txt` æ˜¯å¦å­˜åœ¨
- **æ£€æŸ¥**: æ–‡ä»¶è·¯å¾„æ˜¯å¦æ­£ç¡®
- **æ£€æŸ¥**: æ–‡ä»¶ç¼–ç æ˜¯å¦ä¸ºUTF-8

### é—®é¢˜3: Agentå†³ç­–æ ¼å¼ä¸æ­£ç¡®
- **æ£€æŸ¥**: ä½¿ç”¨çš„promptæ¨¡æ¿æ˜¯å¦æ­£ç¡®
- **æ£€æŸ¥**: LLMè¿”å›çš„å†³ç­–æ˜¯å¦ç¬¦åˆæ¨¡æ¿è¦æ±‚
- **æ£€æŸ¥**: TradeExecutorçš„è§£æé€»è¾‘æ˜¯å¦æ­£ç¡®

## ä¸ç»„å‹ä»£ç çš„æ•´åˆ

### promptsæ–‡ä»¶å¤¹çš„æ•´åˆ

1. **`prompts/agent_prompt.py`**: 
   - ç”¨äºè‚¡ç¥¨äº¤æ˜“ï¼ˆç¾è‚¡/ä¸­è‚¡ï¼‰
   - ä¸æˆ‘ä»¬çš„åŠ å¯†è´§å¸ç³»ç»Ÿç‹¬ç«‹ï¼Œä¸å†²çª

2. **`prompts/natural_language_prompt.txt`**:
   - å·²æ•´åˆåˆ° `PromptManager` ä¸­
   - é€šè¿‡ `create_spot_prompt_from_market_data()` æ–¹æ³•ä½¿ç”¨
   - ä¿æŒç»„å‹æƒ³è¦å®ç°çš„æ•ˆæœï¼ˆä¸¥æ ¼è§„åˆ™ã€JSONè¾“å‡ºç­‰ï¼‰

### ä½¿ç”¨ç»„å‹çš„promptæ¨¡æ¿

```python
from api.agents.prompt_manager import PromptManager
from api.agents.market_collector import MarketDataCollector

# 1. åˆ›å»ºPromptManagerï¼ˆä¼šè‡ªåŠ¨åŠ è½½ç»„å‹çš„æ¨¡æ¿ï¼‰
pm = PromptManager()

# 2. è·å–å¸‚åœºå¿«ç…§
collector = MarketDataCollector(...)
snapshot = collector.get_latest_snapshot()

# 3. ä½¿ç”¨ç»„å‹çš„æ¨¡æ¿åˆ›å»ºprompt
prompt = pm.create_spot_prompt_from_market_data(
    market_snapshot=snapshot,
    price_series="[45000, 45100, 45200]",  # å¯é€‰
    recent_sharpe="0.72"  # å¯é€‰
)

# 4. å‘é€ç»™Agent
agent_manager.broadcast_prompt(role="user", content=prompt)
```

## æ€»ç»“

å®Œæ•´çš„æ•°æ®æµç¡®ä¿äº†ï¼š
1. âœ… Roostooæ•°æ®æ­£ç¡®é‡‡é›†å’Œæ ¼å¼åŒ–
2. âœ… æ•°æ®æ­£ç¡®ä¼ é€’åˆ°Agent
3. âœ… Promptæ­£ç¡®ç”Ÿæˆï¼ˆæ”¯æŒç»„å‹çš„æ¨¡æ¿ï¼‰
4. âœ… Agentæ­£ç¡®ç”Ÿæˆå†³ç­–
5. âœ… å†³ç­–æ­£ç¡®æ‰§è¡Œ

æ‰€æœ‰æ¨¡å—éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¾¿äºç»´æŠ¤å’Œæ‰©å±•ã€‚

